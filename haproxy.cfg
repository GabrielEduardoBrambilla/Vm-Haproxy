#---------------------------------------------------------------------
# HAProxy Configuration - ChamadaQR Project
# SSL Termination + Load Balancing
# VM: 192.168.56.104
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log         127.0.0.1 local2
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

    # SSL/TLS Configuration (TLSv1.2+)
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048

#---------------------------------------------------------------------
# Defaults
#---------------------------------------------------------------------
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option http-server-close
    option forwardfor       except 127.0.0.0/8
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 3000

#---------------------------------------------------------------------
# Frontend - Porta 80 (HTTP) - Redireciona para HTTPS
#---------------------------------------------------------------------
frontend http_front
    bind *:80
    mode http
    
    # Redirecionar todo tráfego HTTP para HTTPS
    redirect scheme https code 301 if !{ ssl_fc }

#---------------------------------------------------------------------
# Frontend - Porta 443 (HTTPS) - SSL Termination
#---------------------------------------------------------------------
frontend https_front
    bind *:443 ssl crt /etc/haproxy/certs/combined.pem alpn h2,http/1.1
    mode http
    
    # Headers de segurança
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # Log do IP real do cliente
    option forwardfor
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 443
    
    # ACLs para roteamento baseado em path
    # IMPORTANTE: Ordem importa! Mais específico primeiro
    acl is_api path_beg /chamadaqr /api
    acl is_keycloak path_beg /realms /admin /resources /js /auth
    acl is_frontend path_beg /
    
    # Roteamento
    use_backend backend_servers if is_api
    use_backend keycloak_server if is_keycloak
    use_backend frontend_servers if is_frontend

#---------------------------------------------------------------------
# Backend - Frontend Servers (Angular + Nginx)
#---------------------------------------------------------------------
backend frontend_servers
    mode http
    balance roundrobin
    option httpchk GET /
    
    # Headers para CORS
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "*"
    
    # Frontend Container 1 (porta 443)
    server frontend1 192.168.56.102:443 check ssl verify none
    
    # Frontend Container 2 (porta 444 - segunda instância)
    server frontend2 192.168.56.102:444 check ssl verify none
    
    # Health check
    http-check expect status 200

#---------------------------------------------------------------------
# Backend - Backend Servers (Spring Boot + Tomcat)
#---------------------------------------------------------------------
backend backend_servers
    mode http
    balance roundrobin
    option httpchk GET /chamadaqr/api/message
    
    # Timeout maior para APIs (operações podem demorar)
    timeout server 2m
    
    # Backend Container 1 (porta 8443)
    server backend1 192.168.56.103:8443 check ssl verify none
    
    # Backend Container 2 (porta 8444 - segunda instância)
    server backend2 192.168.56.103:8444 check ssl verify none
    
    # Health check
    http-check expect status 200

#---------------------------------------------------------------------
# Backend - Keycloak Server
#---------------------------------------------------------------------
backend keycloak_server
    mode http
    balance roundrobin
    option httpchk GET /health/ready
    
    # Timeout maior para Keycloak (autenticação pode demorar)
    timeout server 3m
    
    # Sticky session para Keycloak (IMPORTANTE!)
    cookie KEYCLOAK_SESSION insert indirect nocache httponly secure
    
    # Keycloak Server (porta 5001 - NÃO 443!)
    server keycloak1 192.168.56.103:5001 check ssl verify none cookie keycloak1
    
    # Se tiver backup do Keycloak (descomente quando configurar)
    # server keycloak2 192.168.56.103:5002 check ssl verify none cookie keycloak2 backup
    
    # Health check
    http-check expect status 200

#---------------------------------------------------------------------
# Stats Page (Monitoramento)
#---------------------------------------------------------------------
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats auth admin:ChamadaQR@2024!
    stats show-legends
    stats show-node
    
    # Opcional: mostrar descrição dos servidores
    stats admin if TRUE