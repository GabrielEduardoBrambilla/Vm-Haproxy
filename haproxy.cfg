#---------------------------------------------------------------------
# HAProxy Configuration - ChamadaQR Project
# SSL Termination + Load Balancing + CORS FIX
# VM: 192.168.56.104
#
# ✅ CORRIGIDO: Headers CORS em TODOS os backends
# ✅ CORRIGIDO: Tratamento de requisições OPTIONS (preflight)
# ✅ CORRIGIDO: ACLs incluem /chamadaqr
# ✅ CORRIGIDO: IPs corretos dos containers
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log         127.0.0.1 local2
    # chroot      /var/lib/haproxy
    # pidfile     /var/run/haproxy.pid
    maxconn     4000
    # user        haproxy
    # group       haproxy
    # daemon

    # SSL/TLS Configuration (TLSv1.2+)
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048

#---------------------------------------------------------------------
# Defaults
#---------------------------------------------------------------------
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option http-server-close
    option forwardfor       except 127.0.0.0/8
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 3000

#---------------------------------------------------------------------
# Frontend - Porta 80 (HTTP) - Redireciona para HTTPS
#---------------------------------------------------------------------
frontend http_front
    bind *:80
    mode http
    
    # Redirecionar todo tráfego HTTP para HTTPS
    redirect scheme https code 301 if !{ ssl_fc }

#---------------------------------------------------------------------
# Frontend - Porta 443 (HTTPS) - SSL Termination + CORS
#---------------------------------------------------------------------
frontend https_front
    bind *:443 ssl crt /etc/haproxy/certs/haproxy.pem alpn h2,http/1.1
    mode http


    # ═══════════════════════════════════════════════════════════════
    # CORS - TRATAMENTO DE PREFLIGHT (OPTIONS)
    # ═══════════════════════════════════════════════════════════════
    
    # Detectar requisição OPTIONS (preflight)
    acl is_options method OPTIONS
    
    # Capturar o header Origin para usar na resposta
    http-request set-var(txn.origin) req.hdr(Origin)
    
    # ═══════════════════════════════════════════════════════════════
    # ACLs para roteamento baseado em path
    # ✅ CORRIGIDO: Inclui /chamadaqr
    # ═══════════════════════════════════════════════════════════════
    
    # Backend API (Spring Boot) - ORDEM IMPORTA! Mais específico primeiro
    acl is_api path_beg /chamadaqr
    acl is_api path_beg /api
    
    # Keycloak
    acl is_keycloak path_beg /realms
    acl is_keycloak path_beg /admin
    acl is_keycloak path_beg /resources
    acl is_keycloak path_beg /js
    acl is_keycloak path_beg /auth
    
    # Frontend (Angular) - Tudo que não for API ou Keycloak
    acl is_frontend path_beg /
    
    # ═══════════════════════════════════════════════════════════════
    # CORS - Responder OPTIONS imediatamente (sem ir ao backend)
    # ═══════════════════════════════════════════════════════════════
    
    # Se for OPTIONS para API, responde direto com 204
    http-request return status 204 hdr Access-Control-Allow-Origin "*" hdr Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" hdr Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With, X-Forwarded-For, X-Forwarded-Proto, X-Forwarded-Port" hdr Access-Control-Max-Age "86400" hdr Access-Control-Allow-Credentials "true" if is_options is_api
    
    # Se for OPTIONS para Keycloak, responde direto com 204
    http-request return status 204 hdr Access-Control-Allow-Origin "*" hdr Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" hdr Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" hdr Access-Control-Max-Age "86400" if is_options is_keycloak
    
    # ═══════════════════════════════════════════════════════════════
    # Headers de segurança (aplicados em todas as respostas)
    # ═══════════════════════════════════════════════════════════════
    
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # ═══════════════════════════════════════════════════════════════
    # Headers para proxy reverso
    # ═══════════════════════════════════════════════════════════════
    
    option forwardfor
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 443
    http-request set-header X-Real-IP %[src]
    
    # ═══════════════════════════════════════════════════════════════
    # Roteamento para backends
    # ═══════════════════════════════════════════════════════════════
    
    use_backend backend_servers if is_api
    use_backend keycloak_server if is_keycloak
    default_backend frontend_servers

#---------------------------------------------------------------------
# Backend - Frontend Servers (Angular + Nginx)
#---------------------------------------------------------------------
backend frontend_servers
    mode http
    balance roundrobin
    option httpchk GET /
    
    # ═══════════════════════════════════════════════════════════════
    # CORS Headers para Frontend (arquivos estáticos)
    # ═══════════════════════════════════════════════════════════════
    
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Accept"
    
    # ═══════════════════════════════════════════════════════════════
    # Servidores Frontend (containers na VM 192.168.56.102)
    # ═══════════════════════════════════════════════════════════════
    
    # Frontend Container 1 (porta 8081)
    server frontend1 192.168.56.102:8081 check ssl verify none
    
    # Frontend Container 2 (porta 8082)
    server frontend2 192.168.56.102:8082 check ssl verify none
    
    # Health check
    http-check expect status 200

#---------------------------------------------------------------------
# Backend - Keycloak Server
# ✅ CORRIGIDO: Adicionado CORS headers
#---------------------------------------------------------------------

backend keycloak_server
    mode http
    balance roundrobin
    # Simpler health check - just check if server responds
    option httpchk GET /realms/chamadaqr
    
    # Timeout maior para Keycloak
    timeout server 3m
    
    # Sticky session para Keycloak
    cookie KEYCLOAK_SESSION insert indirect nocache httponly secure
    
    # CORS Headers
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With"
    http-response set-header Access-Control-Allow-Credentials "true"
    http-response set-header Access-Control-Expose-Headers "Authorization"
    
    # Keep HTTPS but with better health check
    server keycloak1 192.168.56.103:5001 check ssl verify none cookie keycloak1
    
    # Health check expects redirect or 200
    http-check expect status 200-399

#---------------------------------------------------------------------
# Stats Page (Monitoramento)
#---------------------------------------------------------------------
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats auth admin:admin
    stats show-legends
    stats show-node
